<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title></title>
  <script>
    "use strict";

    var Impulse = {
      bindDataset: function(controller, funcName) {
        return function(event) {
          return controller[funcName](event.target.dataset);
        }
      },
      
      applyBindings: function(controller, rootElement, bindingsFunc) {
        var bindings = bindingsFunc(controller);
        
        Object.keys(bindings).forEach(function(binding) {
          var elements = rootElement.querySelectorAll(binding);
          
          elements.forEach(function(element) {
            var events = bindings[binding];
            
            Object.keys(events).forEach(function(eventName) {
              var listener = events[eventName];
              
              if (typeof(events[eventName]) == "function") {
                element.addEventListener(eventName, events[eventName], false);
              } else {
                listener.callback = listener.callback.bind(element);

                listener.sources.forEach(function(source) {
                  source.addEventListener(eventName, listener.callback);
                });
              }
            });
            
            if (events.init) {
              events.init.apply(element);
            }
          });
        });

        controller.onBindingsApplied();
      }
    };
    
    Impulse.Observable = function(value, type) {
      this.value = value;
      this.type = type;
      this.listeners = [];
      
      this.addEventListener = function(type, listener) {
        this.listeners.push(listener);
        
        return this;
      };
            
      this.setValue = function(value) {
        if (this.type != null && value.constructor !== this.type) {
          throw Error(value.constructor.name + " does not match observable type " + this.type.name);
        }
        
        this.value = value;
        
        var event = new CustomEvent("update", { detail: value });
        
        var obs = this;
        
        this.listeners.forEach(function(listener) {
          listener.call(obs, event);
        });
      };

      this.getValue = function() {
        return this.value;
      }
      
      this.compose = function(listener, value, type) {
        var observable = new Impulse.Observable(value, type);
        
        this.addEventListener("update", function(event) {
          observable.setValue(listener(event));
        });
        
        return observable;
      }
      
      this.listenTo = function(observable, listener) {
        var _this = this;
        
        observable.addEventListener("update", function(event) {
          _this.setValue(listener(event));
        });
      }

    }
  </script>
</head>
<body>

  <style>
    #calc {
      width: 200px;
      border: 1px solid #606060;
      overflow: hidden;
      box-shadow: 0 0 10px hsla(0, 0%, 0%, 0.5);
    }
    
    #calc * {
      box-sizing: border-box;
      margin: 0; padding: 0;
      font: 20px/1em 'Arial';
      color: #404040;
    }

    #calc h1 {
      background: #606060;
      height: 30px; line-height: 30px;
      color: white; text-align: center;
      text-shadow: 0 1px 1px hsla(0, 0%, 0%, 0.25);
    }

    #calc input {
      width: 100%; height: 40px;
      padding: 0 10px;
      border: 1px solid #606060;
      text-align: right;
    }
        
    #calc button {
      float: left;
      width: 50px; height: 40px;
      border: 1px solid #606060;
      outline: none;
      background: #f0f0f0;
    }
    
    #calc button:active {
      background: #ffffff;
    }
    
    #calc button.tall {
      float: right;
      height: 80px;
    }
    
    #calc button.wide {
      width: 100px;
    }
  </style>

  <div id="calc">
    <h1>Calculator</h1>
    
    <input data-binding="display" readonly />
    
    <button data-action="clear">C</button>
    <button data-number="2"></button>
    <button data-operator="div">÷</button>
    <button data-operator="mul">×</button>

    <button data-number="7">7</button>
    <button data-number="8">8</button>
    <button data-number="9">9</button>
    <button data-operator="sub">−</button>

    <button data-number="4">4</button>
    <button data-number="5">5</button>
    <button data-number="6">6</button>
    <button data-operator="add">+</button>

    <button data-number="1">1</button>
    <button data-number="2">2</button>
    <button data-number="3">3</button>
    <button class="tall" data-operator="eql">=</button>

    <button class="wide" data-number="0">0</button>
    <button data-number=".">.</button>
  </div>

  <br />

  <div id="debug">
    <input data-binding="display" readonly />
  </div>

  <script>
    "use strict";
    
    function Calculator() {
      this.clearDisplay = true;
      this.lastOperator = "eql";
      this.numberValue = new Impulse.Observable(0, Number);
      this.displayString = new Impulse.Observable("", String);

//      this.displayString = this.numberValue.compose(function(event) {
//        return event.detail.toString();
//      }, "", String);

      this.displayString.listenTo(this.numberValue, function(event) {
        return event.detail.toString();
      });

//      var calc = this;
//      this.numberValue.addEventListener("update", function(event) {
//        calc.displayString.setValue(event.detail.toString());
//      });


      this.onBindingsApplied = function() {
        this.displayString.setValue(this.numberValue.getValue().toString());
      }

      this.actionPressed = function(dataset) {
        this.numberValue.setValue(0);
      }
      
      this.numberPressed = function(number) {
        var displayString = this.displayString.getValue();
      
        if (this.clearDisplay) {
          displayString = "";
          
          this.clearDisplay = false;
        }
        
        this.displayString.setValue(displayString + number);
      }
      
      this.operations = {
        eql: function(a, b) { return b; },
        add: function(a, b) { return a + b; },
        sub: function(a, b) { return a - b; },
        mul: function(a, b) { return a * b; },
        div: function(a, b) { return a / b; }
      }
      
      this.operatorPressed = function(dataset) {
        if (!this.clearDisplay) {
          var displayValue = parseFloat(this.displayString.getValue());

          var operation = this.operations[this.lastOperator];
          if (operation != null) {
            this.numberValue.setValue(operation(this.numberValue.getValue(), displayValue));
          }
        }
        
        this.lastOperator = dataset.operator;        
        this.clearDisplay = true;
      }
    }
    
    function Client(numberPressed, operatorPressed) {
    }
    
    var calculator = new Calculator();
    
    Impulse.applyBindings(calculator, document.querySelector("#calc"), function(controller) {
      return {
        "input[data-binding='display']": {
          update: {
            sources: [controller.displayString],
            callback: function(event) { this.value = event.detail; }
          }
        },

        "button[data-action='clear']": {
          //click: Impulse.bindDataset(controller, "actionPressed")
          click: {
            sources: document.querySelectorAll("#calc button[data-action='clear']"),
            callback: Impulse.bindDataset(controller, "actionPressed")
          }
        },
        
        "button[data-number]": {
          click: function(event) { return controller.numberPressed(event.target.dataset["number"]); }
        },
        
        "button[data-operator]": {
          click: Impulse.bindDataset(controller, "operatorPressed")
        }
      }
    });
    
    Impulse.applyBindings(calculator, document.querySelector("#debug"), function(controller) {
      return {
        "input[data-binding='display']": {
          update: {
            sources: [controller.displayString],
            callback: function(event) { this.value = event.detail; }
          }
        },
      }
    });

  </script>
</body>
</html>
